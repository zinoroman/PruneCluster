!function(t,e){if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("undefined"!=typeof module)module.exports=e(require("leaflet"));else{if(!t.L)throw"Leaflet must be loaded previously";var r=e(t.L);t.PruneCluster=r.PruneCluster,t.PruneClusterForLeaflet=r.PruneClusterForLeaflet}}(this,function(t){var e=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function o(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}();!function(t){function r(t,e){return t.lat>=e.minLat&&t.lat<=e.maxLat&&t.lng>=e.minLng&&t.lng<=e.maxLng}function o(t){for(var e,r,o,a=1,i=t.length;a<i;++a){for(o=(r=t[a]).position.lng,e=a-1;e>=0&&t[e].position.lng>o;--e)t[e+1]=t[e];t[e+1]=r}}function a(t,e){return!(e>300)&&e/t<.2}var i=function(){return function(){}}();t.Point=i;var n=function(){return function(){}}();t.ClusterObject=n;var s=1,l=Math.pow(2,53)-1,h=function(t){function r(e,r,o,a,i,n){void 0===o&&(o={}),void 0===i&&(i=1),void 0===n&&(n=!1);var l=t.call(this)||this;return l.data=o,l.position={lat:+e,lng:+r},l.weight=i,l.category=a,l.filtered=n,l.hashCode=s++,l}return e(r,t),r.prototype.Move=function(t,e){this.position.lat=+t,this.position.lng=+e},r.prototype.SetData=function(t){for(var e in t)this.data[e]=t[e]},r}(n);t.Marker=h;var u=function(t){function r(e){var o=t.call(this)||this;return o.stats=[0,0,0,0,0,0,0,0],o.data={},e?(r.ENABLE_MARKERS_LIST&&(o._clusterMarkers=[e]),o.lastMarker=e,o.hashCode=31+e.hashCode,o.population=1,void 0!==e.category&&(o.stats[e.category]=1),o.totalWeight=e.weight,o.position={lat:e.position.lat,lng:e.position.lng},o.averagePosition={lat:e.position.lat,lng:e.position.lng},o):(o.hashCode=1,r.ENABLE_MARKERS_LIST&&(o._clusterMarkers=[]),o)}return e(r,t),r.prototype.AddMarker=function(t){r.ENABLE_MARKERS_LIST&&this._clusterMarkers.push(t);var e=this.hashCode;e=(e<<5)-e+t.hashCode,this.hashCode=e>=l?e%l:e,this.lastMarker=t;var o=t.weight,a=this.totalWeight,i=o+a;this.averagePosition.lat=(this.averagePosition.lat*a+t.position.lat*o)/i,this.averagePosition.lng=(this.averagePosition.lng*a+t.position.lng*o)/i,++this.population,this.totalWeight=i,void 0!==t.category&&(this.stats[t.category]=this.stats[t.category]+1||1)},r.prototype.Reset=function(){this.hashCode=1,this.lastMarker=void 0,this.population=0,this.totalWeight=0,this.stats=[0,0,0,0,0,0,0,0],r.ENABLE_MARKERS_LIST&&(this._clusterMarkers=[])},r.prototype.ComputeBounds=function(t){var e=t.Project(this.position.lat,this.position.lng),r=t.Size,o=Math.floor(e.x/r)*r,a=Math.floor(e.y/r)*r,i=t.UnProject(o,a),n=t.UnProject(o+r,a+r);this.bounds={minLat:n.lat,maxLat:i.lat,minLng:i.lng,maxLng:n.lng}},r.prototype.GetClusterMarkers=function(){return this._clusterMarkers},r.prototype.ApplyCluster=function(t){this.hashCode=41*this.hashCode+43*t.hashCode,this.hashCode>l&&(this.hashCode=this.hashCode=l);var e=t.totalWeight,o=this.totalWeight,a=e+o;this.averagePosition.lat=(this.averagePosition.lat*o+t.averagePosition.lat*e)/a,this.averagePosition.lng=(this.averagePosition.lng*o+t.averagePosition.lng*e)/a,this.population+=t.population,this.totalWeight=a,this.bounds.minLat=Math.min(this.bounds.minLat,t.bounds.minLat),this.bounds.minLng=Math.min(this.bounds.minLng,t.bounds.minLng),this.bounds.maxLat=Math.max(this.bounds.maxLat,t.bounds.maxLat),this.bounds.maxLng=Math.max(this.bounds.maxLng,t.bounds.maxLng);for(var i in t.stats)t.stats.hasOwnProperty(i)&&(this.stats.hasOwnProperty(i)?this.stats[i]+=t.stats[i]:this.stats[i]=t.stats[i]);r.ENABLE_MARKERS_LIST&&(this._clusterMarkers=this._clusterMarkers.concat(t.GetClusterMarkers()))},r.ENABLE_MARKERS_LIST=!1,r}(n);t.Cluster=u;var p=function(){function t(){this._markers=[],this._nbChanges=0,this._clusters=[],this.Size=166,this.ViewPadding=.2}return t.prototype.RegisterMarker=function(t){t._removeFlag&&delete t._removeFlag,this._markers.push(t),this._nbChanges+=1},t.prototype.RegisterMarkers=function(t){var e=this;t.forEach(function(t){e.RegisterMarker(t)})},t.prototype._sortMarkers=function(){var t=this._markers,e=t.length;this._nbChanges&&!a(e,this._nbChanges)?this._markers.sort(function(t,e){return t.position.lng-e.position.lng}):o(t),this._nbChanges=0},t.prototype._sortClusters=function(){o(this._clusters)},t.prototype._indexLowerBoundLng=function(t){for(var e,r,o=this._markers,a=0,i=o.length;i>0;)o[e=a+(r=Math.floor(i/2))].position.lng<t?(a=++e,i-=r+1):i=r;return a},t.prototype._resetClusterViews=function(){for(var t=0,e=this._clusters.length;t<e;++t){var r=this._clusters[t];r.Reset(),r.ComputeBounds(this)}},t.prototype.ProcessView=function(t){var e=Math.abs(t.maxLat-t.minLat)*this.ViewPadding,o=Math.abs(t.maxLng-t.minLng)*this.ViewPadding,a={minLat:t.minLat-e-e,maxLat:t.maxLat+e+e,minLng:t.minLng-o-o,maxLng:t.maxLng+o+o};this._sortMarkers(),this._resetClusterViews();for(var i=this._indexLowerBoundLng(a.minLng),n=this._markers,s=this._clusters,l=s.slice(0),h=i,p=n.length;h<p;++h){var f=n[h],d=f.position;if(d.lng>a.maxLng)break;if(d.lat>a.minLat&&d.lat<a.maxLat&&!f.filtered){for(var m,g=!1,c=0,_=l.length;c<_;++c)if((m=l[c]).bounds.maxLng<f.position.lng)l.splice(c,1),--c,--_;else if(r(d,m.bounds)){m.AddMarker(f),g=!0;break}g||((m=new u(f)).ComputeBounds(this),s.push(m),l.push(m))}}var L=[];for(h=0,p=s.length;h<p;++h)(m=s[h]).population>0&&L.push(m);return this._clusters=L,this._sortClusters(),this._clusters},t.prototype.RemoveMarkers=function(t){if(t){for(var e=0,r=t.length;e<r;++e)t[e]._removeFlag=!0;var o=[];for(e=0,r=this._markers.length;e<r;++e)this._markers[e]._removeFlag?delete this._markers[e]._removeFlag:o.push(this._markers[e]);this._markers=o}else this._markers=[]},t.prototype.FindMarkersInArea=function(t){for(var e=t.minLat,r=t.maxLat,o=t.minLng,a=t.maxLng,i=this._markers,n=[],s=this._indexLowerBoundLng(o),l=i.length;s<l;++s){var h=i[s].position;if(h.lng>a)break;h.lat>=e&&h.lat<=r&&h.lng>=o&&n.push(i[s])}return n},t.prototype.ComputeBounds=function(t,e){if(void 0===e&&(e=!0),!t||!t.length)return null;for(var r=Number.MAX_VALUE,o=-Number.MAX_VALUE,a=Number.MAX_VALUE,i=-Number.MAX_VALUE,n=0,s=t.length;n<s;++n)if(e||!t[n].filtered){var l=t[n].position;l.lat<r&&(r=l.lat),l.lat>o&&(o=l.lat),l.lng<a&&(a=l.lng),l.lng>i&&(i=l.lng)}return{minLat:r,maxLat:o,minLng:a,maxLng:i}},t.prototype.FindMarkersBoundsInArea=function(t){return this.ComputeBounds(this.FindMarkersInArea(t))},t.prototype.ComputeGlobalBounds=function(t){return void 0===t&&(t=!0),this.ComputeBounds(this._markers,t)},t.prototype.GetMarkers=function(){return this._markers},t.prototype.GetPopulation=function(){return this._markers.length},t.prototype.ResetClusters=function(){this._clusters=[]},t}();t.PruneCluster=p}(r||(r={}));var r;r||(r={});var o=(t.Layer?t.Layer:t.Class).extend({initialize:function(e,o){var i=this;void 0===e&&(e=120),void 0===o&&(o=20),this.Cluster=new r.PruneCluster,this.Cluster.Size=e,this.clusterMargin=Math.min(o,e/4),this.Cluster.Project=function(e,r){return i._map.project(new t.LatLng(e,r),Math.floor(i._map.getZoom()))},this.Cluster.UnProject=function(e,r){return i._map.unproject(new t.Point(e,r),Math.floor(i._map.getZoom()))},this._objectsOnMap=[],this.spiderfier=new a(this),this._hardMove=!1,this._resetIcons=!1,this._removeTimeoutId=0,this._markersRemoveListTimeout=[]},RegisterMarker:function(t){this.Cluster.RegisterMarker(t)},RegisterMarkers:function(t){this.Cluster.RegisterMarkers(t)},RemoveMarkers:function(t){this.Cluster.RemoveMarkers(t)},BuildLeafletCluster:function(e,r){var o=this,a=new t.Marker(r,{icon:this.BuildLeafletClusterIcon(e)});return a._leafletClusterBounds=e.bounds,a.on("click",function(){var e=a._leafletClusterBounds,r=o.Cluster.FindMarkersInArea(e),i=o.Cluster.ComputeBounds(r);if(i){var n=new t.LatLngBounds(new t.LatLng(i.minLat,i.maxLng),new t.LatLng(i.maxLat,i.minLng)),s=o._map.getZoom(),l=o._map.getBoundsZoom(n,!1,new t.Point(20,20));if(l===s){for(var h=[],u=0,p=o._objectsOnMap.length;u<p;++u){var f=o._objectsOnMap[u];f.data._leafletMarker!==a&&f.bounds.minLat>=e.minLat&&f.bounds.maxLat<=e.maxLat&&f.bounds.minLng>=e.minLng&&f.bounds.maxLng<=e.maxLng&&h.push(f.bounds)}if(h.length>0){var d=[],m=h.length;for(u=0,p=r.length;u<p;++u){for(var g=r[u].position,c=!1,_=0;_<m;++_){var L=h[_];if(g.lat>=L.minLat&&g.lat<=L.maxLat&&g.lng>=L.minLng&&g.lng<=L.maxLng){c=!0;break}}c||d.push(r[u])}r=d}r.length<200||l>=o._map.getMaxZoom()?o._map.fire("overlappingmarkers",{cluster:o,markers:r,center:a.getLatLng(),marker:a}):l++,o._map.setView(a.getLatLng(),l)}else o._map.fitBounds(n)}}),a},BuildLeafletClusterIcon:function(e){var r="prunecluster prunecluster-",o=38,a=this.Cluster.GetPopulation();return e.population<Math.max(10,.01*a)?r+="small":e.population<Math.max(100,.05*a)?(r+="medium",o=40):(r+="large",o=44),new t.DivIcon({html:"<div><span>"+e.population+"</span></div>",className:r,iconSize:t.point(o,o)})},BuildLeafletMarker:function(e,r){var o=new t.Marker(r);return this.PrepareLeafletMarker(o,e.data,e.category),o},PrepareLeafletMarker:function(t,e,r){if(e.icon&&("function"==typeof e.icon?t.setIcon(e.icon(e,r)):t.setIcon(e.icon)),e.popup){var o="function"==typeof e.popup?e.popup(e,r):e.popup;t.getPopup()?t.setPopupContent(o,e.popupOptions):t.bindPopup(o,e.popupOptions)}},onAdd:function(t){this._map=t,t.on("movestart",this._moveStart,this),t.on("moveend",this._moveEnd,this),t.on("zoomend",this._zoomStart,this),t.on("zoomend",this._zoomEnd,this),this.ProcessView(),t.addLayer(this.spiderfier)},onRemove:function(t){t.off("movestart",this._moveStart,this),t.off("moveend",this._moveEnd,this),t.off("zoomend",this._zoomStart,this),t.off("zoomend",this._zoomEnd,this);for(var e=0,r=this._objectsOnMap.length;e<r;++e)t.removeLayer(this._objectsOnMap[e].data._leafletMarker);this._objectsOnMap=[],this.Cluster.ResetClusters(),t.removeLayer(this.spiderfier),this._map=null},_moveStart:function(){this._moveInProgress=!0},_moveEnd:function(t){this._moveInProgress=!1,this._hardMove=t.hard,this.ProcessView()},_zoomStart:function(){this._zoomInProgress=!0},_zoomEnd:function(){this._zoomInProgress=!1,this.ProcessView()},ProcessView:function(){var e=this;if(this._map&&!this._zoomInProgress&&!this._moveInProgress){for(var r=this._map,o=r.getBounds(),a=Math.floor(r.getZoom()),i=this.clusterMargin/this.Cluster.Size,n=this._resetIcons,s=o.getSouthWest(),l=o.getNorthEast(),h=this.Cluster.ProcessView({minLat:s.lat,minLng:s.lng,maxLat:l.lat,maxLng:l.lng}),u=this._objectsOnMap,p=[],f=new Array(u.length),d=0,m=u.length;d<m;++d){var g=u[d].data._leafletMarker;f[d]=g,g._removeFromMap=!0}var c=[],_=[],L=[],v=[];for(d=0,m=h.length;d<m;++d){for(var M=h[d],k=M.data,C=(M.bounds.maxLat-M.bounds.minLat)*i,P=(M.bounds.maxLng-M.bounds.minLng)*i,y=0,w=v.length;y<w;++y){var b=v[y];if(b.bounds.maxLng<M.bounds.minLng)v.splice(y,1),--y,--w;else{var x=b.averagePosition.lng+P,I=b.averagePosition.lat-C,B=b.averagePosition.lat+C,R=M.averagePosition.lng-P,O=M.averagePosition.lat-C,S=M.averagePosition.lat+C;if(x>R&&B>O&&I<S){k._leafletCollision=!0,b.ApplyCluster(M);break}}}k._leafletCollision||v.push(M)}for(h.forEach(function(r){var o=void 0,i=r.data;if(i._leafletCollision)return i._leafletCollision=!1,i._leafletOldPopulation=0,void(i._leafletOldHashCode=0);var s=new t.LatLng(r.averagePosition.lat,r.averagePosition.lng),l=i._leafletMarker;if(l)if(1===r.population&&1===i._leafletOldPopulation&&r.hashCode===l._hashCode)(n||l._zoomLevel!==a||r.lastMarker.data.forceIconRedraw)&&(e.PrepareLeafletMarker(l,r.lastMarker.data,r.lastMarker.category),r.lastMarker.data.forceIconRedraw&&(r.lastMarker.data.forceIconRedraw=!1)),l.setLatLng(s),o=l;else if(r.population>1&&i._leafletOldPopulation>1&&(l._zoomLevel===a||i._leafletPosition.equals(s))){if(l.setLatLng(s),n||r.population!=i._leafletOldPopulation||r.hashCode!==i._leafletOldHashCode){var h={};t.Util.extend(h,r.bounds),l._leafletClusterBounds=h,l.setIcon(e.BuildLeafletClusterIcon(r))}i._leafletOldPopulation=r.population,i._leafletOldHashCode=r.hashCode,o=l}o?(o._removeFromMap=!1,p.push(r),o._zoomLevel=a,o._hashCode=r.hashCode,o._population=r.population,i._leafletMarker=o,i._leafletPosition=s):(1===r.population?_.push(r):c.push(r),i._leafletPosition=s,i._leafletOldPopulation=r.population,i._leafletOldHashCode=r.hashCode)}),c=_.concat(c),d=0,m=u.length;d<m;++d){var A=(M=u[d]).data;if(g=A._leafletMarker,A._leafletMarker._removeFromMap){var E=!0;if(g._zoomLevel===a){var z=M.averagePosition;for(C=(M.bounds.maxLat-M.bounds.minLat)*i,P=(M.bounds.maxLng-M.bounds.minLng)*i,y=0,w=c.length;y<w;++y){var F=c[y],T=F.data;if(1===g._population&&1===F.population&&g._hashCode===F.hashCode)(n||F.lastMarker.data.forceIconRedraw)&&(this.PrepareLeafletMarker(g,F.lastMarker.data,F.lastMarker.category),F.lastMarker.data.forceIconRedraw&&(F.lastMarker.data.forceIconRedraw=!1)),g.setLatLng(T._leafletPosition),E=!1;else{var j=F.averagePosition,U=z.lng-P,V=j.lng+P;if(x=z.lng+P,I=z.lat-C,B=z.lat+C,R=j.lng-P,O=j.lat-C,S=j.lat+C,g._population>1&&F.population>1&&x>R&&U<V&&B>O&&I<S){g.setLatLng(T._leafletPosition),g.setIcon(this.BuildLeafletClusterIcon(F));var N={};t.Util.extend(N,F.bounds),g._leafletClusterBounds=N,T._leafletOldPopulation=F.population,T._leafletOldHashCode=F.hashCode,g._population=F.population,E=!1}}if(!E){T._leafletMarker=g,g._removeFromMap=!1,p.push(F),c.splice(y,1),--y,--w;break}}}E&&(g._removeFromMap||console.error("wtf"))}}for(d=0,m=c.length;d<m;++d){var D,G=(A=(M=c[d]).data)._leafletPosition;(D=1===M.population?this.BuildLeafletMarker(M.lastMarker,G):this.BuildLeafletCluster(M,G)).addTo(r),D.setOpacity(0),L.push(D),A._leafletMarker=D,D._zoomLevel=a,D._hashCode=M.hashCode,D._population=M.population,p.push(M)}if(window.setTimeout(function(){for(d=0,m=L.length;d<m;++d){var e=L[d];e._icon&&t.DomUtil.addClass(e._icon,"prunecluster-anim"),e._shadow&&t.DomUtil.addClass(e._shadow,"prunecluster-anim"),e.setOpacity(1)}},1),this._hardMove)for(d=0,m=f.length;d<m;++d)(g=f[d])._removeFromMap&&r.removeLayer(g);else{if(0!==this._removeTimeoutId)for(window.clearTimeout(this._removeTimeoutId),d=0,m=this._markersRemoveListTimeout.length;d<m;++d)r.removeLayer(this._markersRemoveListTimeout[d]);var W=[];for(d=0,m=f.length;d<m;++d)(g=f[d])._removeFromMap&&(g.setOpacity(0),W.push(g));W.length>0&&(this._removeTimeoutId=window.setTimeout(function(){for(d=0,m=W.length;d<m;++d)r.removeLayer(W[d]);e._removeTimeoutId=0},300)),this._markersRemoveListTimeout=W}this._objectsOnMap=p,this._hardMove=!1,this._resetIcons=!1}},FitBounds:function(e){void 0===e&&(e=!0);var r=this.Cluster.ComputeGlobalBounds(e);r&&this._map.fitBounds(new t.LatLngBounds(new t.LatLng(r.minLat,r.maxLng),new t.LatLng(r.maxLat,r.minLng)))},GetMarkers:function(){return this.Cluster.GetMarkers()},RedrawIcons:function(t){void 0===t&&(t=!0),this._resetIcons=!0,t&&this.ProcessView()}}),a=(t.Layer?t.Layer:t.Class).extend({_2PI:2*Math.PI,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_spiralCountTrigger:8,spiderfyDistanceMultiplier:1,initialize:function(e){this._cluster=e,this._currentMarkers=[],this._multiLines=!!t.multiPolyline,this._lines=this._multiLines?t.multiPolyline([],{weight:1.5,color:"#222"}):t.polyline([],{weight:1.5,color:"#222"})},onAdd:function(t){this._map=t,this._map.on("overlappingmarkers",this.Spiderfy,this),this._map.on("click",this.Unspiderfy,this),this._map.on("zoomend",this.Unspiderfy,this)},Spiderfy:function(e){var r=this;if(e.cluster===this._cluster){this.Unspiderfy();var o=e.markers.filter(function(t){return!t.filtered});this._currentCenter=e.center;var a,i=this._map.latLngToLayerPoint(e.center);o.length>=this._spiralCountTrigger?a=this._generatePointsSpiral(o.length,i):(this._multiLines&&(i.y+=10),a=this._generatePointsCircle(o.length,i));for(var n=[],s=[],l=[],h=0,u=a.length;h<u;++h){var p=this._map.layerPointToLatLng(a[h]),f=this._cluster.BuildLeafletMarker(o[h],e.center);f.setZIndexOffset(5e3),f.setOpacity(0),this._currentMarkers.push(f),this._map.addLayer(f),s.push(f),l.push(p)}window.setTimeout(function(){for(h=0,u=a.length;h<u;++h)s[h].setLatLng(l[h]).setOpacity(1);var o=+new Date,i=window.setInterval(function(){n=[];var s=+new Date-o;if(s>=290)window.clearInterval(i),p=1;else var p=s/290;var f=e.center;for(h=0,u=a.length;h<u;++h){var d=l[h],m=d.lat-f.lat,g=d.lng-f.lng;n.push([f,new t.LatLng(f.lat+m*p,f.lng+g*p)])}r._lines.setLatLngs(n)},42)},1),this._lines.setLatLngs(n),this._map.addLayer(this._lines),e.marker&&(this._clusterMarker=e.marker.setOpacity(.3))}},_generatePointsCircle:function(e,r){var o,a,i=this.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+e)/this._2PI,n=this._2PI/e,s=[];for(s.length=e,o=e-1;o>=0;o--)a=this._circleStartAngle+o*n,s[o]=new t.Point(Math.round(r.x+i*Math.cos(a)),Math.round(r.y+i*Math.sin(a)));return s},_generatePointsSpiral:function(e,r){var o,a=this.spiderfyDistanceMultiplier*this._spiralLengthStart,i=this.spiderfyDistanceMultiplier*this._spiralFootSeparation,n=this.spiderfyDistanceMultiplier*this._spiralLengthFactor,s=0,l=[];for(l.length=e,o=e-1;o>=0;o--)s+=i/a+5e-4*o,l[o]=new t.Point(Math.round(r.x+a*Math.cos(s)),Math.round(r.y+a*Math.sin(s))),a+=this._2PI*n/s;return l},Unspiderfy:function(){for(var t=0,e=this._currentMarkers.length;t<e;++t)this._currentMarkers[t].setLatLng(this._currentCenter).setOpacity(0);var r=this._map,o=this._currentMarkers;window.setTimeout(function(){for(t=0,e=o.length;t<e;++t)r.removeLayer(o[t])},300),this._currentMarkers=[],this._map.removeLayer(this._lines),this._clusterMarker&&this._clusterMarker.setOpacity(1)},onRemove:function(t){this.Unspiderfy(),t.off("overlappingmarkers",this.Spiderfy,this),t.off("click",this.Unspiderfy,this),t.off("zoomend",this.Unspiderfy,this)}});return{PruneCluster:r,PruneClusterForLeaflet:o}});